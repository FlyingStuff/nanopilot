cmake_minimum_required(VERSION 2.6)

project(msgbus-build)
set(CMAKE_BUILD_TYPE Debug)

list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_LIST_DIR}/cmake")

find_package(cmp)
find_package(cmp_mem_access)

include_directories(..) # for autogenerated type files


SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++0x -Wall")
SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall")

include(${CMAKE_CURRENT_LIST_DIR}/cmake/type_compiler.cmake)



set(MSBGUS_SRC
    ./msgbus.c
    ./serialization_msgpack.c
    ./type_print.c
    )

add_executable(
    msgbus_unittests
    ${MSBGUS_SRC}
    ./tests/atomicity.cpp
    ./tests/bus_test.cpp
    ./tests/cpp_wrapper_test.cpp
    ./tests/mocks/assert.cpp
    ./tests/mocks/synchronization.cpp
    ./tests/serialization_msgpack_test.cpp
    ./tests/signaling.cpp
    ./tests/subscriber_test.cpp
    ./tests/topic_test.cpp
    ./tests/type_print_test.cpp
    ${TYPE_OUTPUT_DIR}/test.c
    ./tests/runner.cpp
    ${CMP_SOURCES}
    ${CMP_MEM_ACCESS_SOURCES}
    )

type_compile(${CMAKE_CURRENT_SOURCE_DIR}/tests/types/test.type)
target_include_directories(msgbus_unittests PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/tests)
target_include_directories(msgbus_unittests PUBLIC ${TYPE_FILE_INCLUDE_DIR})


target_link_libraries(
    msgbus_unittests
    m
    CppUTest
    CppUTestExt
    )

enable_testing()
add_test(msgbus_unittests msgbus_unittests)

list(APPEND ALL_UNIT_TESTS ${CMAKE_CURRENT_BINARY_DIR}/msgbus_unittests)

if(CMAKE_PROJECT_NAME STREQUAL PROJECT_NAME)
    FOREACH(t ${ALL_UNIT_TESTS})
        LIST(APPEND ALL_UNIT_TESTS_AS_COMMAND COMMAND;echo;${t})
        LIST(APPEND ALL_UNIT_TESTS_AS_COMMAND COMMAND;${t};-c)
    ENDFOREACH()
    add_custom_target(check ${ALL_UNIT_TESTS_AS_COMMAND} DEPENDS ${ALL_UNIT_TESTS})
else()
    set(ALL_UNIT_TESTS ${ALL_UNIT_TESTS} PARENT_SCOPE)
endif()



add_executable(
    msgbus_demo
    ./msgbus.c
    ./examples/posix/demo.c
    ./ports/posix/msgbus_port.c
    ${TYPE_OUTPUT_DIR}/example_type.c
    )

type_compile(${CMAKE_CURRENT_SOURCE_DIR}/examples/posix/example_type.type)
target_include_directories(msgbus_demo PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/ports/posix)
target_include_directories(msgbus_demo PUBLIC ${TYPE_FILE_INCLUDE_DIR})

target_link_libraries(
    msgbus_demo
    pthread
    )

